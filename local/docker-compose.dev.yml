name: skillswap-dev

services:
  # -------------------------
  # KEYCLOAK + DB
  # -------------------------
  keycloak-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    networks:
      - skillswap-net

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.4
    restart: unless-stopped
    depends_on:
      - keycloak-db
    command: ["start-dev", "--import-realm"]
    ports:
      - "8080:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin

      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak

      KC_HTTP_ENABLED: "true"
      KC_PROXY: "edge"
      KC_HTTP_COMPRESSION: "false"
      KC_SPI_THEME_CACHE_THEMES: "false"
      KC_SPI_THEME_CACHE_TEMPLATES: "false"
    volumes:
      - ./keycloak/import:/opt/keycloak/data/import:ro
      - ./keycloak/themes:/opt/keycloak/themes:ro
    networks:
      - skillswap-net

  # -------------------------
  # RABBITMQ (needed by user-service and message-service)
  # -------------------------
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - skillswap-net

  # -------------------------
  # REDIS (caching, sessions, rate limiting)
  # -------------------------
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - skillswap-net

  # -------------------------
  # API-GATEWAY
  # -------------------------
  api-gateway:
    build:
      context: ../../skillswap-backend
      dockerfile: api-gateway/Dockerfile
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      KEYCLOAK_ISSUER_URI: http://localhost:8080/realms/skillswap-dev
      KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/skillswap-dev/protocol/openid-connect/certs
      USER_SERVICE_URL: http://user-service:8082
      MESSAGE_SERVICE_URL: http://message-service:8083

      # RabbitMQ for GDPR event orchestration
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: "5672"
      RABBIT_USERNAME: guest
      RABBIT_PASSWORD: guest
    depends_on:
      - keycloak
      - rabbitmq
      - user-service
      - message-service
    networks:
      - skillswap-net

  # -------------------------
  # USER-SERVICE (uses Supabase DB from env file)
  # -------------------------
  user-service:
    build:
      context: ../../skillswap-backend
      dockerfile: user-service/Dockerfile
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      KEYCLOAK_ISSUER_URI: http://localhost:8080/realms/skillswap-dev
      KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/skillswap-dev/protocol/openid-connect/certs

      # Redis for caching and rate limiting
      REDIS_HOST: redis
      REDIS_PORT: "6379"

      # RabbitMQ for user.deleted event
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: "5672"
      RABBIT_USERNAME: guest
      RABBIT_PASSWORD: guest
    env_file:
      # This loads your Supabase DB settings from the backend repo .env
      - ../../skillswap-backend/.env
    depends_on:
      - rabbitmq
      - redis
      - keycloak
    networks:
      - skillswap-net

  # -------------------------
  # MESSAGE-SERVICE (WebSocket, RabbitMQ, Redis)
  # -------------------------
  message-service:
    build:
      context: ../../skillswap-backend
      dockerfile: message-service/Dockerfile
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      KEYCLOAK_ISSUER_URI: http://localhost:8080/realms/skillswap-dev
      KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/skillswap-dev/protocol/openid-connect/certs

      # Redis for caching, sessions, rate limiting
      REDIS_HOST: redis
      REDIS_PORT: "6379"

      # RabbitMQ for event-driven messaging
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: "5672"
      RABBIT_USERNAME: guest
      RABBIT_PASSWORD: guest

      # User service for validation
      USER_SERVICE_URL: http://user-service:8082
    env_file:
      - ../../skillswap-backend/.env
    depends_on:
      - rabbitmq
      - redis
      - keycloak
      - user-service
    networks:
      - skillswap-net

  # -------------------------
  # FRONTEND (Vite build -> Nginx)
  # -------------------------
  frontend:
    build:
      context: ../../skillswap-frontend
      dockerfile: Dockerfile
      args:
        VITE_KEYCLOAK_URL: http://localhost:8080
        VITE_KEYCLOAK_REALM: skillswap-dev
        VITE_KEYCLOAK_CLIENT_ID: skillswap-frontend
        VITE_API_BASE_URL: http://localhost:8081
    restart: unless-stopped
    ports:
      - "5173:80"
    depends_on:
      - api-gateway
      - keycloak
    networks:
      - skillswap-net

networks:
  skillswap-net:

volumes:
  keycloak-db-data:
  redis-data: