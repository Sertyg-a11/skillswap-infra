apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: skillswap-keycloak
  namespace: argocd
  labels:
    app.kubernetes.io/name: skillswap-keycloak
    app.kubernetes.io/component: auth
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://codecentric.github.io/helm-charts
    chart: keycloak
    targetRevision: 18.4.4
    helm:
      values: |
        replicas: 1
        image:
          repository: quay.io/keycloak/keycloak
          tag: "25.0.6"
        command:
          - "/opt/keycloak/bin/kc.sh"
          - "start-dev"
        extraEnv: |
          - name: KEYCLOAK_ADMIN
            value: admin
          - name: KEYCLOAK_ADMIN_PASSWORD
            value: admin
          - name: KC_DB
            value: postgres
          - name: KC_DB_URL
            value: jdbc:postgresql://skillswap-postgres:5432/keycloak
          - name: KC_DB_USERNAME
            value: skillswap
          - name: KC_DB_PASSWORD
            value: skillswap
          - name: KC_HEALTH_ENABLED
            value: "true"
        service:
          type: ClusterIP
        postgresql:
          enabled: false
        startupProbe: |
          httpGet:
            path: /realms/master
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          failureThreshold: 60
          timeoutSeconds: 1
        livenessProbe: |
          httpGet:
            path: /realms/master
            port: http
          initialDelaySeconds: 0
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        readinessProbe: |
          httpGet:
            path: /realms/master
            port: http
          initialDelaySeconds: 10
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 1
        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 1Gi
            cpu: 1000m
  destination:
    server: https://kubernetes.default.svc
    namespace: skillswap
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
